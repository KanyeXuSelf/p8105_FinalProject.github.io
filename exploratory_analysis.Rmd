---
title: "Exploratory Analysis"

output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r, warning = FALSE, message = FALSE}

library(rvest)
library(dplyr)
library(tidyverse)
library(httr)
library(ggplot2)
library(tidyr)
library(maps)
library(knitr)
library(viridis)
library(broom)

knitr::opts_chunk$set(
  fig.width = 8,      
  fig.asp = 0.75,     
  out.width = "80%"   
)


theme_set(theme_minimal() + theme(legend.position = "right"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r}

# Data import
rm(list = ls())

country_overall <- read.csv("data/country_overall.csv")
esports_top100 <- read.csv("data/esports_earnings_top100_overall.csv")
top500_365 <- read.csv("data/top500_365.csv")
earnings_country <- read.csv("data/Earnings_country_2018_2024.csv")
earnings_topgame <- read.csv("data/Earnings_topgame_2018_2024.csv")

country_overall$Total_Earnings <- as.numeric(gsub("[\\$,]", "", country_overall$Total_Earnings))
esports_top100$Total_Earnings <- as.numeric(gsub("[\\$,]", "", esports_top100$Total_Earnings))
top500_365$`Total..Last.365.Days.` <- as.numeric(gsub("[\\$,]", "", top500_365$`Total..Last.365.Days.`))
earnings_country$Overall_Earnings <- as.numeric(gsub("[\\$,]", "", earnings_country$Overall_Earnings))
earnings_topgame$Total_Earnings <- as.numeric(gsub("[\\$,]", "", earnings_topgame$Total_Earnings))

```

## Horizontal Analysis

### 1. Total Earning vs. Top Game Earnings

In this section, we analyze the top 10 countries in esports based on total earnings, with additional focus on the revenue distribution, the dominance of the top game, and the player base. This helps us understand the economic concentration in esports and its relationship with player participation.

Revenue Concentration:

 - How much of a country's esports revenue is dominated by a single game?
- Are certain countries heavily reliant on one top game for their earnings, indicating a concentrated esports ecosystem?

Cross-Country Differences:

- Do countries differ significantly in their revenue distribution between total earnings and top game earnings?
- Are there countries with more diversified revenue sources compared to others where a single game dominates?


```{r}

# Extract the games with the largest percentage of revenue and their revenue
top_countries <- country_overall %>%
  arrange(desc(Total_Earnings)) %>%
  head(10) %>%
  mutate(
    Top_Game_Earnings = as.numeric(gsub("[\\$,]", "", Earnings_From_Top_Game)),
    Player_Count = as.numeric(gsub("[^0-9]", "", Number_of_Players)),  
    Top_Game_Percent = round((Top_Game_Earnings / Total_Earnings) * 100, 2)  
  )

top_countries_long <- top_countries %>%
  select(Country, Total_Earnings, Top_Game_Earnings, Top_Game) %>%
  pivot_longer(
    cols = c(Total_Earnings, Top_Game_Earnings),
    names_to = "Earnings_Type",
    values_to = "Earnings"
  ) %>%
  mutate(
    Earnings_Type = ifelse(Earnings_Type == "Total_Earnings", "Total Earnings", "Top Game Earnings"),
    Game_Label = ifelse(Earnings_Type == "Top Game Earnings", Top_Game, NA)  # Only add label for top game earnings
  )

head(top_countries_long)
```

This bar chart compares the total earnings and earnings from the top game for the top 10 countries in e-sports from the top-performing game in each country.

```{r}

ggplot(top_countries_long, aes(x = reorder(Country, -Earnings), y = Earnings, fill = Earnings_Type)) +
  geom_bar(stat = "identity", position = "identity", alpha = 0.9) +
  geom_text(
    aes(label = Game_Label), 
    position = position_stack(vjust = 0.5),  # Position label in the middle of the "Top Game Earnings" bar
    na.rm = TRUE, 
    size = 3, 
    color = "black"  # Adjust text color if needed
  ) +
  coord_flip() +
  scale_fill_manual(values = c("blue", "#ADD8E6")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Top 10 Countries: Total vs. Top Game Earnings",
    x = "Country", y = "Earnings (USD)", fill = "Earnings Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "top",
    axis.text.y = element_text(size = 10)
  )



```

From the chart, we can see China leads significantly in both categories, with the United States and Korea following. The dominance of top games in total earnings varies, with some countries like Korea showing a higher reliance on top games, while others like Denmark and Brazil have a more diversified earnings distribution.


The second chart focuses on compare the percentage of revenue generated by the top game for each country. It reveals the dependency of each country's esports economy on a single title.

```{r}

ggplot(top_countries, aes(x = reorder(Country, -Top_Game_Percent), y = Top_Game_Percent, fill = Country)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_viridis_d() +
  labs(
    title = "Percentage of Revenue from Top Game",
    x = "Country", y = "Percentage (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "none",
    axis.text.y = element_text(size = 10)
  )


```

This visualization provides a bubble chart to analyze the relationship between the number of esports players and their total earnings for each country. 

```{r}

ggplot(top_countries, aes(x = reorder(Country, -Player_Count), y = Player_Count, size = Total_Earnings, color = Player_Count)) +
  geom_point(alpha = 0.7) +
  coord_flip() +
  scale_y_continuous(labels = scales::comma) +
  scale_size_continuous(labels = scales::comma) +
  scale_color_viridis_c(option = "viridis") + 
  labs(
    title = "Total Players by Country (Bubble Size = Total Earnings)",
    x = "Country", y = "Number of Players",
    size = "Total Earnings (USD)",
    color = "Player Count"  
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.text.y = element_text(size = 10),
    legend.position = "bottom" 
  )


```

### 2. Top Players analysis

In this section, we analyze **individual player performance** based on the top players and top 500 players' earnings data. This provides insights into individual dominance in esports and the geographic distribution of esports performance.

This provide us a overview of top 10 players and their earnings

```{r}

# Extract the top 10 players
top_players <- esports_top100 %>%
  arrange(desc(Total_Earnings)) %>%
  head(10)

# Create a bar chart for the top 10 players by earnings
ggplot(top_players, aes(x = reorder(Player_Name, Total_Earnings), y = Total_Earnings, fill = Highest_Paying_Game)) +
  geom_bar(stat = "identity", alpha = 0.8) +  # Add alpha for lighter colors
  geom_text(
    aes(label = paste0("ID: ", Player_ID, "\n$", formatC(Total_Earnings, format = "f", big.mark = ","))),
    hjust = 1, size = 3, color = "white"  # Set text color to white
  ) +  # Add Player ID and earnings as labels
  coord_flip() +
  scale_fill_viridis_d(option = "viridis", name = "Top Game", begin = 0.3, end = 0.8) + 
  labs(
    title = "Top 10 Players by Total Earnings",
    x = "Player Name",
    y = "Total Earnings (USD)",
    fill = "Top Game"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10)
  )



```

All of the top 10 highest-earning players have earned their fortunes from Dota 2, with Johan Sundstein (N0tail) leading the list at over $7 million, highlighting the game's massive prize pools and dominance in esports earnings.

Then we expand our focus to top 500 players

```{r}

# Summary table for top 500
country_summary <- top500_365 %>%
  group_by(Country) %>%
  summarise(
    Player_Count = n(),  # Count the number of players
    Total_Earnings = sum(`Total..Last.365.Days.`, na.rm = TRUE)  # Sum up earnings
  ) %>%
  arrange(desc(Player_Count))  # Sort by the number of players


kable(
  country_summary %>%
    slice_max(Player_Count, n = 10),  
  col.names = c("Country", "Player Count", "Total Earnings (USD)"),
  caption = "Top 10 Countries: Player Count and Total Earnings"
)
```



The distribution of top 500 players by country

```{r}

# Filter small values and group as "Other"
threshold <- 10  # Define a threshold for minimum player count
country_summary1 <- country_summary %>%
  mutate(
    Country = ifelse(Player_Count <= threshold, "Other", Country)  # Group smaller countries as "Other"
  ) %>%
  group_by(Country) %>%
  summarise(
    Player_Count = sum(Player_Count),  # Sum counts for "Other"
    .groups = "drop"
  )

# Create a pie chart with viridis colors
ggplot(country_summary1, aes(x = "", y = Player_Count, fill = Country)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_viridis_d(option = "plasma", name = "Country") +  # Use the "plasma" palette from viridis
  labs(
    title = "Top 500 Players by Country (Proportion)",
    x = NULL,
    y = NULL
  ) +
  theme_void() +  # Remove grid and axis elements
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )


```

The distribution of top 500 players earnings by country

```{r}

# Filter small values and group as "Other"
threshold <- 2e6  # Define a threshold for minimum total earnings
country_summary2 <- country_summary %>%
  mutate(
    Country = ifelse(Total_Earnings <= threshold, "Other", Country)  # Group smaller countries as "Other"
  ) %>%
  group_by(Country) %>%
  summarise(
    Total_Earnings = sum(Total_Earnings),  # Sum earnings for "Other"
    .groups = "drop"
  )

# Create a pie chart with viridis colors
ggplot(country_summary2, aes(x = "", y = Total_Earnings, fill = Country)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_viridis_d(option = "plasma", name = "Country") +  # Use the "plasma" palette from viridis
  labs(
    title = "Total Earnings by Country (Top 500 Players)",
    x = NULL,
    y = NULL
  ) +
  theme_void() +  # Remove grid and axis elements
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )

```


- From Top 500 Players by Country (Proportion), **United States, China, and South Korea** dominate in player representation, reflecting strong esports ecosystems.The "Other" category includes countries with fewer top players, highlighting the concentration of talent in key regions.
- From Total Earnings by Country (Top 500 Players), **China** leads in total earnings, followed by the **United States** and **South Korea**, showcasing financial dominance. Smaller countries like **Denmark** and **Ukraine** excel in earnings despite fewer players, indicating high efficiency and performance.
- Esports talent and earnings are concentrated in a few regions, with smaller countries showing strong player efficiency.


The distribution of top players earning by countries

```{r}

# Clean and prepare data
top500_365 <- top500_365 %>%
  mutate(
    Total_Earnings = as.numeric(gsub("[^0-9.]", "", Total..Last.365.Days.)),  # Clean earnings column
    Country = as.factor(Country)  # Ensure Country is a factor for grouping
  ) %>%
  drop_na(Total_Earnings)  # Remove rows with missing earnings

# Filter countries with more than 10 players
filtered_countries <- top500_365 %>%
  group_by(Country) %>%
  filter(n() > 5)  # Keep only countries with more than 10 players

# Create the boxplot
ggplot(filtered_countries, aes(x = reorder(Country, -Total_Earnings, median), y = log(Total_Earnings), fill = Country)) +
  geom_boxplot(outlier.color = "red", outlier.shape = 16, outlier.size = 1.5, alpha = 0.7) +
  labs(
    title = "Distribution of Player Earnings by Country (Log Scale)",
    x = "Country",
    y = "Log Total Earnings (USD)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    plot.title = element_text(size = 16, face = "bold")
  )



```



## Longitudinal comparison

After examining horizontal comparisons, we now turn to the **longitudinal analysis** from a time perspective. This section investigates the trends in total earnings across years, top-performing countries, and the most popular games from **2018 to 2024**.

### 1. Overall Earnings Trend (2018-2024)

- **Objective**: To understand the overall growth and decline of esports earnings over time.
- **Key Findings**:
    - Total earnings increased significantly from **2018 to 2019**, suggesting growing interest and investment in the esports industry.
    - A sharp decline in **2020** aligns with the global COVID-19 pandemic, which disrupted live tournaments—a major revenue source.
    - Earnings rebounded strongly in **2021**, reaching the highest point in the observed period, likely due to adaptation to **online tournaments** and increased **digital engagement**.
    - From **2022 to 2024**, there was a steady decline in total earnings, possibly reflecting:
        - Market saturation.
        - Reduced growth in audience engagement or sponsorship.

```{r, warning = FALSE, message = FALSE}

# Summarize yearly earnings
yearly_earnings <- earnings_country %>%
  group_by(Year) %>%
  summarize(Total_Earnings = sum(Overall_Earnings, na.rm = TRUE))
head(yearly_earnings)

# Plot the trend line
ggplot(yearly_earnings, aes(x = Year, y = Total_Earnings)) +
  geom_line(color = "#ADD8E6", size = 1) +
  geom_point(color = "blue", size = 2) +
  labs(
    title = "Total Earnings Trends Over Time (2018-2024)",
    x = "Year",
    y = "Total Earnings (USD)"
  ) +
  theme_minimal()

```

### 2. Top 10 Countries Earnings Trend (2018-2024)

- **Objective**: To analyze earnings trends for the top 10 countries in total earnings over the observed years.
- **Findings**:
    - **China and the United States** are clear leaders in esports earnings, with significant peaks in **2021**.
    - **Korea**, **United Kingdom**, and **Russian Federation** demonstrate moderate performance.
    - The **COVID-19 pandemic in 2020** caused noticeable disruptions, but most countries recovered in **2021** before entering a gradual decline through **2024**.
    
```{r}
# Step 1: Summarize yearly earnings by country
yearly_country_earnings <- earnings_country %>%
  group_by(Year, Countries) %>%
  summarize(Total_Earnings = sum(Overall_Earnings, na.rm = TRUE), .groups = "drop")

head(yearly_country_earnings)

# Step 2: Identify the top 10 countries by total earnings
top_countries <- yearly_country_earnings %>%
  group_by(Countries) %>%
  summarize(Total_Earnings = sum(Total_Earnings, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Total_Earnings)) %>%
  slice_head(n = 10)  # Select the top 10 countries

# Step 3: Filter the data for only the top 10 countries
top_country_trends <- yearly_country_earnings %>%
  filter(Countries %in% top_countries$Countries)

# Step 4: Plot yearly trends for the top 10 countries with a consistent color theme
ggplot(top_country_trends, aes(x = Year, y = Total_Earnings, color = Countries)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_color_viridis_d(option = "plasma", name = "Country") +  # Use the "plasma" palette from viridis
  labs(
    title = "Yearly Earnings Trends for Top 10 Countries (2018-2024)",
    x = "Year",
    y = "Total Earnings (USD)",
    color = "Country"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "right",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    legend.key.size = unit(0.6, "cm")  # Adjust legend key size for better fit
  )


```

### 3. Top 10 Games Earnings Trend (2018-2024)

- **Objective**: To explore trends in earnings for the top 10 games, identified by their total combined earnings from 2018 to 2024.
- **Key Findings**:
    - **Dota 2** consistently dominates the earnings chart:
        - Significant peak in **2018** (~$80 million).
        - Remains a top contributor throughout the years despite fluctuations.
    - **Fortnite** saw a sharp rise post-2018 and maintained high earnings, competing closely with Dota 2 between **2020-2022**.
    - **Counter-Strike** shows steady growth, while **League of Legends** demonstrates smaller but stable earnings.
    - **Valorant** and **PUBG Mobile** (PLAYERUNKNOWN’S BATTLEGROUNDS) exhibit growth after **2020**, reflecting increasing popularity.
    - **Rocket League** and **Rainbow Six Siege** show declining trends post-2022, suggesting reduced popularity or activity in competitive scenes.


```{r, warning = FALSE, message = FALSE}

# top 10 games
top_games <- earnings_topgame %>%
  group_by(Game) %>%
  summarize(Total_Earnings = sum(Total_Earnings)) %>%
  arrange(desc(Total_Earnings)) %>%
  head(10) %>%
  pull(Game)

top_game_trends <- earnings_topgame %>%
  filter(Game %in% top_games)

# plot
ggplot(top_game_trends, aes(x = Year, y = Total_Earnings, color = Game)) +
  geom_line(size = 1) +  
  geom_point(size = 1.5) +  
  scale_color_viridis_d(option = "plasma", name = "Game") +  # Use a high-contrast "plasma" palette
  labs(
    title = "Trends for Top 10 Games (2018-2024)",
    x = "Year",
    y = "Total Earnings (USD)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.position = "right",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

```


### 4. Overall Observations

- **Pandemic Impact (2020)**:
    - Earnings across most games and countries declined significantly due to disruptions in live events caused by the COVID-19 pandemic.
    - However, certain games and regions adapted quickly with online tournaments, showcasing the resilience of the esports market.

- **Post-2020 Recovery**:
    - Many games and countries saw earnings rebound strongly in **2021**.
    - Despite the peak, the industry faced steady declines in subsequent years, highlighting challenges such as:
        - Market saturation.
        - Evolving audience preferences.
        - Shifting sponsorship dynamics.


### 5. Visualization Summary

1. **Overall Earnings Trend**: 
    - Highlights year-over-year fluctuations in total earnings across all countries.
    - Captures significant events like the pandemic's impact and the subsequent recovery.

2. **Top Countries Trend**:
    - Tracks the earnings of the top 10 countries, showcasing regional performance variations.

3. **Top Games Trend**:
    - Focuses on the top 10 games by total earnings, analyzing their growth, decline, and market relevance over time.
    